<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width" />
		<title>历史书-地图</title>
		<script type="text/javascript" src="http://webapi.amap.com/maps?v=1.4.1&key=f1c8c370f7738e458c5c70a1df52984b&plugin=AMap.Autocomplete,AMap.PlaceSearch"></script>
		<!-- 引入样式 -->
		<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
		<link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
		<!-- 引入组件库 -->
		<script src="https://unpkg.com/element-ui/lib/index.js"></script>
		<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
		<style>
			body,
			html {
				position: relative;
				height: 100%;
				margin: 0;
				padding: 0;
			}
			
			.amap-container {
				z-index: 1;
			}
			
			#mapBox {
				position: absolute;
				z-index: 2;
				top: 0;
				left: 0;
				width: 100%;
			}
			
			#container {
				width: 100%;
				height: 100%;
			}
			
			* {
				box-sizing: border-box;
			}
			
			#myPage {
				position: absolute;
				right: 10px;
				bottom: 0px;
				background-color: #fff;
				text-align: center;
				border-radius: 10px;
				box-shadow: 0px 2px 4px 0px silver;
			}
			
			#tipinput {
				width: 400px;
			}
			
			.amap-sug-result {
				display: none;
			}
			
			.amap-logo {
				display: none !important;
			}
			
			.toolsBar {
				position: absolute;
				height: 1.5vw;
				top: 0;
				width: 80%;
				background-color: #F4F3F1;
				z-index: 2;
			}
			
			.toolsBar-btn {
				border: 1px solid #A3A7A6;
				z-index: 2;
				height: 1.5vw;
				width: 1.5vw;
				background-size: 100% 100%;
				background-repeat: no-repeat;
				background-color: transparent;
				float: left;
				cursor: pointer;
			}
			
			.windowInput {
				width: 260px;
			}
			
			.saveBtn {
				color: #fff;
				background-color: #99d465;
				border-color: #8cce51;
				cursor: pointer;
				background-image: none;
				border: 1px solid transparent;
				white-space: nowrap;
				padding: 6px 12px;
				font-size: 14px;
				line-height: 2.4;
				border-radius: 4px;
			}
			
			.tuding1 {
				background-image: url("http://49.235.128.250:8084/upload/tuding1.png");
			}
			
			.tuding2 {
				background-image: url("http://49.235.128.250:8084/upload/panel.png");
			}
			
			.tuding3 {
				background-image: url("http://49.235.128.250:8084/upload/panel.png");
			}
			
			.panel {
				width: 10vw;
				height: calc(100% - 1.5vw);
				position: absolute;
				top: 1.5vw;
			}
			
			.full {
				height: 100%;
				width: 100%;
			}
		</style>
	</head>

	<body>
		<div id="container"></div>
		<div id="mapBox">
			<div id="myPage">
				<!--<p>请输入关键字：</p>-->
				<input id="tipinput" placeholder="  请输入关键字：" />
			</div>
			<div class="toolsBar">
				<a class="tuding1 toolsBar-btn" @click="btnClick(1)"></a>
				<a class="tuding2 toolsBar-btn" @click="btnClick(2)"></a>
			</div>
			<div class="panel" v-if="btnShow2">
				<el-tree :data="data" :props="defaultProps" @node-click="handleNodeClick"></el-tree>
			</div>
		</div>

	</body>
	<script type="text/javascript">
		//axios加请求头
		axios.interceptors.request.use(
			config => {
				config.cancelToken = new axios.CancelToken(c => {
					config.cancel = c
				})
				let authorization = getcookie('Authorization')
				if(
					authorization === '' ||
					authorization === undefined ||
					authorization === null
				) {
					// cookies里面不存在token则跳转到login界面
					window.location.href = '/#/login'
				} else {
					// 增加token
					config.headers['token'] = authorization
					//允许的header类型
					return config
				}
				return config
			},
			function(error) {
				return Promise.reject(error)
			}
		)

		function getcookie(objname) { //获取指定名称的cookie的值
			var arrstr = document.cookie.split("; ");
			for(var i = 0; i < arrstr.length; i++) {
				var temp = arrstr[i].split("=");
				if(temp[0] == objname) return unescape(temp[1]);
			}
		}

		var mapObj = [{
			currentX: 0,
			currentY: 0,
			positionName: '' //全局的地标名字
		}]
		var MYURL = "http://49.235.128.250:8084/"
		var currentX, currentY
		window.onload = function() {
			queryAxios() //查询州县树的数据
		};

		function queryAxios() {
			axios.get(MYURL + 'QueryTableRow.do', {
					params: {
						tablename: "map",
						showcol: "*",
						sqlwhere: " 1=1"
					}
				})
				.then(function(res) {
					mapObj = res.data.data
					for(let i = 0; i < mapObj.length; i++) {
						writePoint(mapObj[i].positionX, mapObj[i].positionY, mapObj[i].positionName)
					}
				})
		}

		function saveAxios() {
			var values = [currentX, currentY, document.getElementById('windowInput').value,localStorage.getItem('username')]
			axios.post(MYURL + 'InsertTableRow_Origin.do', {
					params: {
						tablename: "map",
						Insertcol: "positionX,positionY,positionName,creator",
						values: [values]
					}
				})
				.then(function(res) {
					alert(res.data.msg)
				})
		}

		//地图加载
		var infoWindow;
		var map = new AMap.Map("container", {
			mapStyle: "amap://styles/8e37443f34f0cdda4db2fef99e5e9fb4", //设置地图的显示样式
			resizeEnable: true,
			zoom: 13 //放大比例
		});
		//输入提示
		var autoOptions = {
			input: "tipinput" //绑定地图的输入框
		};
		
		var auto = new AMap.Autocomplete(autoOptions);
		var placeSearch = new AMap.PlaceSearch({
			//新建的一个map
			map: map
		}); //构造地点查询类

		var satelliteLayer = new AMap.TileLayer.Satellite();
		//批量添加图层
		map.add([satelliteLayer]);

		AMap.event.addListener(auto, "select", select); //注册监听，当选中某条记录时会触发
		function select(e) {
			placeSearch.setCity(e.poi.adcode);
			placeSearch.search(e.poi.name); //关键字查询查询
		}
		AMap.event.addListener(placeSearch, "markerClick", function(e) {
			//监听搜索显示的Mark点击事件
			debugger
			console.log(e.data.name);
			document.getElementById("tipinput").value = e.data.name;
		});
		/**---------++++++...............|||||||||||||||||||........++++++--------***/
		AMap.plugin("AMap.Geocoder", function() {
			var geocoder = new AMap.Geocoder({
				city: "010" //城市，默认：“全国”
			});
			var marker = new AMap.Marker({
				map: map,
				bubble: true
			});
			map.on("click", function(e) {
				console.log("map-click");
				var lat = e.lnglat.lat;
				var lng = e.lnglat.lng;
				var lnglatmsg = [];
				var daddress, addressname;
				lnglatmsg.push(lng);
				lnglatmsg.push(lat);
				marker.setPosition(e.lnglat);
				geocoder.getAddress(e.lnglat, function(status, result) {
					//console.log(result);
					daddress =
						result.regeocode.addressComponent.province +
						result.regeocode.addressComponent.district +
						result.regeocode.addressComponent.township +
						result.regeocode.addressComponent.street +
						result.regeocode.addressComponent.streetNumber;
					addressname = result.regeocode.formattedAddress;
					if(status == "complete") {
						document.getElementById("tipinput").value =
							result.regeocode.formattedAddress;
					}
					openInfo(lnglatmsg, addressname, daddress);
				});
			});
		});

		function showInfoM(e) {
			debugger
		}
		//在指定位置打开信息窗体
		function openInfo(lnglatmsg, addressname, daddress) {
			currentX = lnglatmsg[0];
			currentY = lnglatmsg[1];
			positionName = addressname
			positionAdress = daddress
			//构建信息窗体中显示的内容
			let infoWindowHtml =
				`
            <div style=\"padding:0px 0px 0px 4px;\"><b style=\"color:#2a2a2a;font-size: 14px;\">已将坐标定位为</b><br>
            <hr>
            <input class="windowInput" id ="windowInput" value=` +
				addressname +
				`>` +
				`</input><br>
            <span style=\"padding: 5px 0px;font-size: 12px;color: #a0a0a0;\">地址 :` +
				daddress +
				`</span><br>
           		 <a id="certainInfo" class="saveBtn" onclick="saveAxios()">保存</a>
            </div>`;
			infoWindow = new AMap.InfoWindow({
				panel: "panel",
				placeSearch: true,
				asOrigin: true,
				asDestination: true,
				content: infoWindowHtml //使用默认信息窗体框样式，显示信息内容
			});
			infoWindow.open(map, lnglatmsg);
		}
		//写点
		function writePoint(x, y, positionName) {
			var marker = new AMap.Marker({
				position: map.getCenter(),
				icon: 'http://49.235.128.250:8084/upload/maker.png',
				position: [x, y],
			});

			marker.setMap(map);
			// 设置鼠标划过点标记显示的文字提示
			//			marker.setTitle('我是marker的title');

			// 设置label标签
			// label默认蓝框白底左上角显示，样式className为：amap-marker-label
			marker.setLabel({
				offset: new AMap.Pixel(0, 0), //设置文本标注偏移量
				content: "<div class='info'>" + positionName + "</div>", //设置文本标注内容
				direction: 'bottom' //设置文本标注方位
			});
			marker.on('click', showInfoM);
			
		}

		//5 数组转tree
		function composeTree(list = []) {
			//const data = JSON.parse(JSON.stringify(list)) // 浅拷贝不改变源数据
			const data = list
			const result = []
			if(!Array.isArray(data)) {
				return result
			}
			data.forEach(item => {
				// delete item.children
				item.children = []
			})
			const map = {}
			data.forEach(item => {
				map[item.id] = item
			})
			data.forEach(item => {
				const parent = map[item.F_parent]
				if(parent) {
					(parent.children || (parent.children = [])).push(item)
				} else {
					result.push(item)
				}
			})
			return result
		}
		// 树结构排序
		function sort(data, id) {
			function sortArr(data) {
				if(Array.isArray(data)) {
					data = data.sort(function(a, b) {
						return a[id] - b[id]
					})
					// 排序子对象
					for(let i = 0; i < data.length; i++) {
						sortArr(data[i].children)
					}
				}
			}
			sortArr(data)
			return data
		}

		var vm = new Vue({
			el: '#mapBox',
			data: {
				btnShow2: false,
				data: [],
				defaultProps: {
					children: 'children',
					label: 'name'
				}
			},
			methods: {
				btnClick(num) {
					if(num == 1) {

					}
					if(num == 2) {
						vm.btnShow2 = !vm.btnShow2
					}
				},
				handleNodeClick(data) {
					console.log(data);
				},
				queryCounty() {
					axios.get(MYURL + 'QueryTableRow.do', {
							params: {
								tablename: "county",
								showcol: "*",
								sqlwhere: " 1=1",
							}
						})
						.then(res => {
							vm.data = composeTree(res.data.data)
						})
				}
			},
			mounted() {
				this.queryCounty()
			}
		})
	</script>

</html>